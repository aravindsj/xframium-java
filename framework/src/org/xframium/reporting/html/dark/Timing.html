<!DOCTYPE html>
<html ng-app="xImage">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-animate.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular-sanitize.js"></script>
<script src="http://xframium.org/output/assets/js/ui-bootstrap-tpls-2.1.4.js"></script>
<script src="http://xframium.org/output/assets/js/angular-ui-tree.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>
<script src="http://xframium.org/output/assets/js/angular-chart.js"></script>
<script src="./Test.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link href="http://www.xframium.org/output/assets/css/toolkit-inverse.css" rel="stylesheet">
<link href="http://www.xframium.org/output/assets/css/application.css" rel="stylesheet">
<link href="http://www.xframium.org/output/assets/css/angular-ui-tree.css" rel="stylesheet">
</head>
<body ng-controller="xTimingController" data-ng-init="initialize()">
    <div class="container-fluid">
        <div class="col-sm-12 content">
            <canvas class="chart chart-bar" chart-data="timingData" chart-labels="timingLabels" chart-options="chartOptions" chart-colors="chartColors"></canvas>
        </div>
        <div class="col-sm-5"></div>
        <div class="col-sm-2" style="text-align: center; margin-top: 25px">
            <span class="btn btn-primary"  ng-click="downloadCSV()">Download Timing Report</span>
        </div>
        <div class="col-sm-5"></div>
    </div>
</body>
<script>
    var xGrid = angular.module('xImage', [ 'ngAnimate', 'ngSanitize', 'ui.bootstrap', 'chart.js' ]);

    xGrid
            .controller(
                    'xTimingController',
                    function XImageController( $scope, $uibModal )
                    {
                        $scope.testData = testData.pageData;

                        $scope.timingLabels = [];
                        $scope.timingData = [];
                        $scope.timings = [];

                        $scope.initialize = function()
                        {
                            $scope.getTimings();

                            console.log($scope.timingLabels);

                        }

                        $scope.downloadCSV = function()
                        {
                            var lineArray = [];

                            lineArray.push("data:text/csv;charset=utf-8," + $scope.timingDataDownloadHeaders);

                            $scope.timings.forEach(function( row, index )
                            {
                                var line = $scope.timingDataDownloadCols.map(function( val )
                                {
                                    return "\x22" + row[val] + "\x22";
                                }).join(",");

                                lineArray.push(line);
                            });

                            var csvContent = lineArray.join("\n");
                            var encodedUri = encodeURI(csvContent);

                            window.open(encodedUri);
                        }

                        $scope.getTimings = function()
                        {
                            var testLevelData = {
                                "script" : $scope.testData.testName,
                                "execId" : $scope.testData.sessionId,
                                "startTime" : $scope.testData.startTime.raw,
                                "endTime" : $scope.testData.endTime.raw,
                                "startTimeFormatted" : $scope.testData.startTime.dateTime,
                                "endTimeFormatted" : $scope.testData.endTime.dateTime,
                                "pmUser" : $scope.testData.cloudDescriptor.userName,
                                "user" : "n/a",
                                "data" : "n/a",
                                "wifi" : "n/a",
                                "hsId" : $scope.testData.device.deviceName,
                                "hsOperator" : "n/a",
                                "hsManufacturer" : $scope.testData.device.manufacturer,
                                "hsModel" : $scope.testData.device.model,
                                "hsOS" : $scope.testData.device.os,
                                "hsOSVer" : $scope.testData.device.osVersion,
                                "networkCarrier" : "n/a",
                                "networkSpeed" : "",
                                "latency" : "",
                                "inBandwidth" : "",
                                "outBandwidth" : "",
                                "city" : "n/a",
                                "country" : "n/a",
                                "mobileAppVersion" : "",
                                "environment" : $scope.testData.device.environment,
                                "appName" : "",
                                "webReport" : $scope.testData.executionParameters.PERFECTO_WT
                            };

                            $scope.testData.stepList.forEach(function( step )
                            {
                                $scope.walkStepToGetTimeings(step, testLevelData);
                            });
                        }

                        $scope.walkStepToGetTimeings = function( step, testLevelData )
                        {
                            var txName = step.step.name;
                            var duration = step.endTime.raw - step.startTime.raw;
                            var is_checkpoint = (step.step.kw == "WAIT_FOR");

                            if ( step.timingMap.elapsed ) {
                                var row = Object.assign({}, testLevelData);

                                row.txName = txName;
                                row.txTimeStart = step.startTime.raw;
                                row.txTimeEnd = step.endTime.raw;
                                row.txTimeStartFormatted = step.startTime.dateTime;
                                row.txTimeEndFormatted = step.endTime.dateTime;
                                row.validationSuccess = ("SUCCESS" == step.stepStatus);
                                row.timerUx = step.timingMap.ux;
                                row.requestTime = step.timingMap.device;
                                row.responseTime = step.timingMap.elapsed;
                                row.requestTimestamp = "";
                                row.responseTimestamp = "";
                                row.vitalsTimestamp = "";
                                row.vitalsTimestampFormatted = "";
                                row.vitalseCPU = "";
                                row.vitalsMemFree = "";
                                row.vitalsMemUsed = "";
                                row.vitalsMemCached = "";

                                $scope.timings.push(row);
                            }

                            if ( step.step.timed ) {
                                $scope.timingLabels.push(txName);
                                $scope.timingData.push(duration);
                            }

                            if ( step.stepList ) {
                                step.stepList.forEach(function( subStep )
                                {
                                    $scope.walkStepToGetTimeings(subStep, testLevelData);
                                });
                            }
                        }

                        $scope.timingDataDownloadHeaders = "\x22Script\x22,\x22ExecId\x22,\x22Time Start\x22,\x22Time End\x22,\x22Time Start Formatted\x22,\x22Time End Formatted\x22,\x22PM User\x22,\x22User\x22,\x22Data\x22,\x22Wifi\x22,\x22HS Id\x22,\x22HS Operator\x22,\x22HS Manufacturer\x22,\x22HS Model\x22,\x22HS OS\x22,\x22HS OS Ver.\x22,\x22Network Carrier\x22,\x22Network Speed\x22,\x22Latency\x22,\x22IN Bandwidth\x22,\x22OUT Bandwidth\x22,\x22Transaction Name\x22,\x22Transaction Time Start\x22,\x22Transaction Time End\x22,\x22Transaction Time Start Formatted\x22,\x22Transaction Time End Formatted\x22,\x22Validation Success\x22,\x22Timer UX\x22,\x22Request Time\x22,\x22Response Time\x22,\x22Request Timestamp [ms]\x22,\x22Response Timestamp [ms]\x22,\x22Vitals Timestamp\x22,\x22Vitals Timestamp Formatted\x22,\x22Vitals CPU\x22,\x22Vitals Mem Free\x22,\x22Vitals Mem Used\x22,\x22Vitals Mem Cached\x22,\x22City\x22,\x22Country\x22,\x22Mobile App Version\x22,\x22Environment\x22,\x22App Name\x22,\x22Web Report\x22";

                        $scope.timingDataDownloadCols = [ "script", "execId", "startTime", "endTime", "startTimeFormatted", "endTimeFormatted", "pmUser", "user", "data", "wifi",

                        "hsId", "hsOperator", "hsManufacturer", "hsModel", "hsOS", "hsOSVer", "networkCarrier", "networkSpeed", "latency", "inBandwidth",

                        "outBandwidth", "txName", "txTimeStart", "txTimeEnd", "txTimeStartFormatted", "txTimeEndFormatted", "validationSuccess", "timerUx", "requestTime", "responseTime",

                        "requestTimestamp", "responseTimestamp", "vitalsTimestamp", "vitalsTimestampFormatted", "vitalseCPU", "vitalsMemFree", "vitalsMemUsed", "vitalsMemCached", "city", "country",

                        "mobileAppVersion", "environment", "appName", "webReport" ];

                    });
</script>
</html>
